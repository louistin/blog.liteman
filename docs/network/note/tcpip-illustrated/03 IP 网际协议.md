# 03 IP 网际协议

> 不可靠 unreliable
>> 不保证 IP 数据报能成功到达目的地, 任务的可靠性需要由上层来提供

> 无连接 connectionless
>> IP 并不维护任何关于后续数据报的状态信息, 每个数据报处理相互独立. 发送到达顺序, 路径均可不同

## IP 首部

**IP 首部**
<img :src="$withBase('/image/network/tcpip-illustrated/03/ip_header_001.png')" alt="IP 首部">


```bash
高位                                                        低位
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version|  IHL  |Type of Service|          Total Length         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Identification        |Flags|      Fragment Offset    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Time to Live |    Protocol   |         Header Checksum       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Address                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Version 版本
    目前为 4, 即 IPv4
IHL 首部长度
TOS 服务类型
    3bit 优先权子段 + 4bit TOS 子段 + 1bit 0
    TOS 子段
        最小时延
        最大吞吐量
        最高可靠性
        最小费用
Total Length 整个 IP 数据报长度
    16 bit, 最大长度 = 2^16 - 1 = 65535 byte
Identification 标识字段
    唯一的标识主机发送的每一份数据报, 通常每次 +1
TTL 生存时间
    数据报可以经过的最多路由器数, 每次 -1, 防止由于路由环路导致的不停转发
    TTL 为 0 时, 数据报被丢弃, 并发送 ICMP 报文通知源主机
Protocol
    标识上层所使用的协议(TCP UDP 等)
Header Checksum
    IP Header 部分的校验和, 不包括数据部分
Source Address / Destination Address
    除非使用 NAT, 否则整个传输中, 二者不变
Options
    以 32bit 为界限, 必要时插入 0 填充, 保证 IP 首部始终是 32bit 的整数倍
```

```bash
big endian 字节序
    传输顺序为 0-7, 8-15, 16-23, 24-31 bit
    TCP/IP 首部中所有二进制整数在网络中传输都为此次序
```

## IP 路由选择

```bash
1. 如果目的主机与源主机直接相连, 或在一个共享网络上, IP 数据报直接送到目的主机上.
2. 不直接相连时, 主机把数据报发往默认的路由器上, 又路由器转发该数据报

IP 层既可以配置成路由器功能, 也可以配置成主机功能.
    主机不会把数据报从一个接口转发到另一个接口, 路由器会转发.
IP 在内存中有一个路由表, 当收到一份数据报并进行发送时, 都要对该表搜索一次.
    接收到某个网络接口的数据报时, 检查目的 IP 地址是否为本机 IP 地址或 IP 广播地址, 是则由
      对应协议模块处理. 不是则, IP 层设置为路由器功能就转发, 否则就丢弃数据报

路由表信息
    目的 IP 地址
    下一站路由器 IP 地址 / 直连网络 IP 地址
    标志
        其中一个标志致命目的 IP 地址是网络地址还是主机地址
        另一个标志致命下一站路由器是否为真正的下一站路由器, 还是直连接口
    为数据报的传输指定一个网络接口

IP 路由选择
    通过逐跳来实现
    数据报在各站的传输过程中目的 IP 地址始终不变, 但是封装和目的链路层地址每一站都可以改变.
```

## 子网

```bash
A B 类地址一般都要进行子网划分, 用于子网号的比特数通过子网掩码来指定.

B 类地址子网编址
    一种划分: 16bit 网络号 + 8bit 子网号 + 8bit 主机号
子网编址可以缩小 Internet 路由表规模.

子网掩码
    值为 1 的比特留给网络号和子网号, 为 0 的比特留给主机号
```

## 特殊情况 IP

**特殊 IP地址**<br>
<img :src="$withBase('/image/network/tcpip-illustrated/03/special_ip_001.png')" alt="特殊 IP地址">

## 命令

```bash
[root@ ~]# ifconfig
docker0: flags=4099<UP,BROADCAST,MULTICAST>  mtu 1500
        inet 172.18.0.1  netmask 255.255.0.0  broadcast 172.18.255.255
        inet6 fe80::42:1eff:fe10:960f  prefixlen 64  scopeid 0x20<link>
        ether 02:42:1e:10:96:0f  txqueuelen 0  (Ethernet)
        RX packets 624  bytes 106169 (103.6 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 502  bytes 1028258 (1004.1 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 172.17.0.2  netmask 255.255.240.0  broadcast 172.17.15.255
        inet6 fe80::5054:ff:fe1d:9861  prefixlen 64  scopeid 0x20<link>
        ether 52:54:00:1d:98:61  txqueuelen 1000  (Ethernet)
        RX packets 9793138  bytes 2358843500 (2.1 GiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 9564495  bytes 1925846680 (1.7 GiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 7566  bytes 371672 (362.9 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 7566  bytes 371672 (362.9 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

[root@ ~]# ifconfig eth0
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 172.17.0.2  netmask 255.255.240.0  broadcast 172.17.15.255
        inet6 fe80::5054:ff:fe1d:9861  prefixlen 64  scopeid 0x20<link>
        ether 52:54:00:1d:98:61  txqueuelen 1000  (Ethernet)
        RX packets 9793152  bytes 2358844444 (2.1 GiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 9564505  bytes 1925848928 (1.7 GiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

[root@ ~]# netstat -in
Kernel Interface table
Iface             MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg
docker0          1500      624      0      0 0           502      0      0      0 BMU
eth0             1500  9793168      0      0 0       9564517      0      0      0 BMRU
lo              65536     7566      0      0 0          7566      0      0      0 LRU
````


## FAQ

1. 给定 IP 地址和子网掩码, 可以知道哪些信息?
> 本机 IP 的类型, 子网号, 主机号

2. 环回地址必须是 127.0.0.1 吗?
> 不是必须. 127.0.0.0 - 127.255.255.255 均是环回地址
